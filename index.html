<!-- 最初に読んだ本 セクション（ここを index.html の適当な場所に貼ってください） -->
<section id="firstBookSection" style="margin:20px 0; padding:14px; border:1px dashed #ddd; border-radius:10px; background:#fff;">
  <h2 style="margin:0 0 10px;">最初に読んだ本</h2>

  <div id="fb-view" style="display:none; align-items:center; gap:12px;">
    <img id="fb-cover" src="" alt="cover" style="width:96px;height:140px;object-fit:cover;border-radius:6px;border:1px solid #ccc;">
    <div>
      <div id="fb-info" style="font-weight:700"></div>
      <div id="fb-sub" style="color:#666;margin-top:6px"></div>
      <div style="margin-top:10px;">
        <button id="fb-edit" type="button">編集</button>
        <button id="fb-clear" type="button">削除</button>
      </div>
    </div>
  </div>

  <form id="fb-form" style="display:grid; grid-template-columns:1fr 120px; gap:10px; align-items:start;">
    <div>
      <label style="display:block;font-size:13px;color:#333;">タイトル</label>
      <input id="fb-title" type="text" placeholder="書名を入力" style="width:100%;padding:8px;border-radius:6px;border:1px solid #ccc;">
      <label style="display:block;font-size:13px;color:#333;margin-top:8px;">著者</label>
      <input id="fb-author" type="text" placeholder="著者名（任意）" style="width:100%;padding:8px;border-radius:6px;border:1px solid #ccc;">
      <label style="display:block;font-size:13px;color:#333;margin-top:8px;">ISBN（任意）</label>
      <input id="fb-isbn" type="text" placeholder="ISBN（ハイフン可）" style="width:100%;padding:8px;border-radius:6px;border:1px solid #ccc;">
      <div style="margin-top:8px;color:#555;font-size:13px;">
        ※ Open Library / Google Books を使って書影を取得します
      </div>
    </div>

    <div style="display:flex;flex-direction:column; gap:8px;">
      <button id="fb-fetch" type="button" style="padding:10px;border-radius:8px;">カバーを取得</button>
      <button id="fb-save" type="button" style="padding:10px;border-radius:8px;">保存</button>
      <div id="fb-status" style="color:#666;font-size:13px;"></div>
    </div>
  </form>
</section>

<script>
(function(){
  const qs = (s) => document.querySelector(s);
  const fbTitle = qs('#fb-title');
  const fbAuthor = qs('#fb-author');
  const fbIsbn = qs('#fb-isbn');
  const fbFetch = qs('#fb-fetch');
  const fbSave = qs('#fb-save');
  const fbStatus = qs('#fb-status');
  const fbCoverImg = qs('#fb-cover');
  const fbView = qs('#fb-view');
  const fbForm = qs('#fb-form');
  const fbInfo = qs('#fb-info');
  const fbSub = qs('#fb-sub');
  const fbEdit = qs('#fb-edit');
  const fbClear = qs('#fb-clear');

  const STORAGE_KEY = 'reading_memo_first_book';

  // 画像存在チェック用（Image オブジェクト）
  function imageExists(url){
    return new Promise((res) => {
      const img = new Image();
      img.onload = () => res(true);
      img.onerror = () => res(false);
      img.src = url + (url.indexOf('?') === -1 ? '?cache=' + Date.now() : '&cache=' + Date.now());
    });
  }

  // Open Library: ISBN カバー
  async function tryOpenLibraryIsbn(isbn){
    if(!isbn) return null;
    const norm = isbn.replace(/[^0-9Xx]/g, '');
    const url = `https://covers.openlibrary.org/b/isbn/${norm}-L.jpg`;
    if(await imageExists(url)) return url;
    return null;
  }

  // Open Library: 検索（title/author）
  async function tryOpenLibrarySearch(title, author){
    if(!title) return null;
    const q = encodeURIComponent(title + (author ? ' ' + author : ''));
    try {
      const res = await fetch(`https://openlibrary.org/search.json?q=${q}&limit=5`);
      if(!res.ok) return null;
      const data = await res.json();
      if(data.docs && data.docs.length){
        // できるだけ cover_i を使う
        for(const d of data.docs){
          if(d.cover_i){
            const url = `https://covers.openlibrary.org/b/id/${d.cover_i}-L.jpg`;
            if(await imageExists(url)) return url;
          }
          if(d.isbn && d.isbn.length){
            // try first ISBN
            const tryIsbn = d.isbn[0];
            const byIsbn = await tryOpenLibraryIsbn(tryIsbn);
            if(byIsbn) return byIsbn;
          }
        }
      }
    } catch(e){ /* ignore */ }
    return null;
  }

  // Google Books: search
  async function tryGoogleBooks(title, author, isbn){
    try {
      let url = null;
      if(isbn){
        const norm = isbn.replace(/[^0-9Xx]/g, '');
        url = `https://www.googleapis.com/books/v1/volumes?q=isbn:${encodeURIComponent(norm)}`;
      } else {
        let q = title;
        if(author) q += ' ' + author;
        url = `https://www.googleapis.com/books/v1/volumes?q=${encodeURIComponent(q)}&maxResults=5`;
      }
      const res = await fetch(url);
      if(!res.ok) return null;
      const data = await res.json();
      if(data.totalItems > 0 && data.items && data.items.length){
        for(const item of data.items){
          const img = item.volumeInfo?.imageLinks;
          if(img && (img.large || img.thumbnail || img.smallThumbnail)){
            // prefer large
            const found = img.large || img.thumbnail || img.smallThumbnail;
            if(await imageExists(found)) return found;
          }
        }
      }
    } catch(e){ /* ignore */ }
    return null;
  }

  async function fetchCover(){
    fbStatus.textContent = '検索中…';
    const title = fbTitle.value.trim();
    const author = fbAuthor.value.trim();
    const isbn = fbIsbn.value.trim();
    let cover = null;

    // 1) ISBN Open Library
    if(isbn){
      cover = await tryOpenLibraryIsbn(isbn);
    }
    // 2) Open Library search
    if(!cover && title){
      cover = await tryOpenLibrarySearch(title, author);
    }
    // 3) Google Books fallback
    if(!cover){
      cover = await tryGoogleBooks(title, author, isbn);
    }

    if(cover){
      fbCoverImg.src = cover;
      fbStatus.textContent = 'カバーを取得しました。プレビューを確認して「保存」を押してください。';
    } else {
      fbCoverImg.src = '';
      fbStatus.textContent = 'カバーが見つかりませんでした。ISBN を入れるか、手動で画像URLを差し替えてください。';
    }
    return cover;
  }

  // 表示切替（保存済みの表示）
  function renderSaved(book){
    if(!book){
      fbView.style.display = 'none';
      fbForm.style.display = 'grid';
      return;
    }
    fbForm.style.display = 'none';
    fbView.style.display = 'flex';
    fbCoverImg.src = book.cover || '';
    fbInfo.textContent = book.title || '';
    fbSub.textContent = [book.author || '', book.isbn ? ('ISBN: ' + book.isbn) : ''].filter(Boolean).join(' / ');
  }

  // 保存・読み込み
  function saveBook(book){
    localStorage.setItem(STORAGE_KEY, JSON.stringify(book));
  }
  function loadBook(){
    try {
      const v = localStorage.getItem(STORAGE_KEY);
      return v ? JSON.parse(v) : null;
    } catch(e){ return null; }
  }
  function clearBook(){
    localStorage.removeItem(STORAGE_KEY);
  }

  // イベント
  fbFetch.addEventListener('click', async () => {
    await fetchCover();
  });

  fbSave.addEventListener('click', async () => {
    // もしまだカバーが空なら先に取得する
    if(!fbCoverImg.src){
      await fetchCover();
    }
    const book = {
      title: fbTitle.value.trim(),
      author: fbAuthor.value.trim(),
      isbn: fbIsbn.value.trim(),
      cover: fbCoverImg.src || ''
    };
    if(!book.title){
      fbStatus.textContent = 'タイトルを入力してください。';
      return;
    }
    saveBook(book);
    renderSaved(book);
    fbStatus.textContent = '保存しました。';
  });

  fbEdit.addEventListener('click', () => {
    const book = loadBook();
    if(book){
      fbTitle.value = book.title || '';
      fbAuthor.value = book.author || '';
      fbIsbn.value = book.isbn || '';
      fbCoverImg.src = book.cover || '';
    }
    renderSaved(null);
    fbStatus.textContent = '編集モードです。変更して「保存」してください。';
  });

  fbClear.addEventListener('click', () => {
    if(!confirm('本当に削除しますか？')) return;
    clearBook();
    renderSaved(null);
    fbStatus.textContent = '削除しました。';
  });

  // 初期ロード
  document.addEventListener('DOMContentLoaded', () => {
    const book = loadBook();
    renderSaved(book);
  });
})();
</script>
